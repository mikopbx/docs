# Настройка интеграции с amoCRM

### Системные требования <a href="#sistemnye_trebovanija" id="sistemnye_trebovanija"></a>

* АТС должна быть доступна на "_белом_" адресе
* Адреса должен быть доступен по **https** протоколу, необходимо получить SSL сертификат (см. [lets encrypt модуль](../module-get-ssl-lets-encrypt.md))
* Работа виджета проверена на браузерах семейства Chrome: **Google Chrome**, **Yandex браузер**

## Настройка внутри MikoPBX <a href="#nastrojka" id="nastrojka"></a>

1. Откройте web-интерфейс MikoPBX. Перейдите в раздел «**Модули**» - «**Маркетплейс модулей**».
2. Установите «**Модуль связи с AmoCRM**»

<figure><img src="../../../.gitbook/assets/image (40).png" alt=""><figcaption><p>Модуль связи с AmoCRM</p></figcaption></figure>

3. Перейдите к редактированию настроек модуля. На вкладке «**Настройка подключения**» заполните поле «**Адрес портала**».
4. Сгенерируйте новый «**Ключ доступа к API MikoPBX**»

Выполните действие «**Сохранить**», далее - включите модуль.

5. Выполните авторизацию на портале amoCRM. Это действие выполнит установку модуля на портал.

<figure><img src="../../../.gitbook/assets/image (41).png" alt=""><figcaption><p>Авторизация модуля</p></figcaption></figure>

Модуль автоматически заполнит настройка на вкладке «Создание сущностей»:

<figure><img src="../../../.gitbook/assets/image (42).png" alt=""><figcaption><p>Вкладка "Создание сущностей"</p></figcaption></figure>



## Настройка внутри AmoCRM

1. Перейдите в интерфейс портала amoCRM. Откройте **amoМаркет.**
2. Перейдите на вкладку «**Установленные**».
3. Откройте настройки виджета MikoPBX.
4. Укажите «**Адрес сервера MikoPBX**» - публичный адрес, на котором доступна АТС.
5. Заполните «**Токен**», его значение следует взять из настроек АТС «**Ключ доступа к API MikoPBX**».
6. Назначьте внутренние номера в разделе: «**Пользователи АТС**».

Сохраните настройки.

<figure><img src="../../../.gitbook/assets/image (43).png" alt=""><figcaption><p>Данные внутри AmoCRM</p></figcaption></figure>

### Web hooks <a href="#web_hooks" id="web_hooks"></a>

{% hint style="info" %}
Web hooks позволят более оперативно синхронизировать сущности с MikoPBX.
{% endhint %}

1. Откройте **amoМаркет.**
2. Перейдите по кнопке «**WEB HOOKS**».
3.  Добавьте новое правило для адреса:

    ```
    https://АДРЕС_АТС_MIKOPBX/pbxcore/api/amo-crm/v1/entity-update
    ```
4. Выберите события «контакт удален» / «сделка удалена» / «компания удалена».
5. Сохраните настройки.

{% hint style="success" %}
Если возникают сложности при настройке, Вы можете [обратиться к нам](https://www.mikopbx.ru/support/) за помощью.
{% endhint %}

## Создание сущностей <a href="#sozdanie_suschnostej" id="sozdanie_suschnostej"></a>

Модуль может автоматически создавать следующие сущности:

* **Контакт** - карточка клиента
  *   Шаблон имени нового контакта - к примеру

      ```
      Новый контакт <PhoneNumber>
      ```

      Параметр **\<PhoneNumber>** будет заменен на номер телефона клиента.
* **Неразобранное**
* **Сделка**
  *   «_Шаблон наименования_» - к примеру

      ```
      Новая сделка <PhoneNumber>
      ```
  * «_Воронка_» - к ней будет отнесена сделка,
  * «_Этап воронки_» - статус сделки в воронке
  * «_Ответственный_» - «первый, кто ответил на вызов», «последний, кто ответил на вызов»
* **Задача** - будет создана задача с крайним сроком выполнения, срок назначается в часах, относительно даты создания задачи
  *   _Наименование задачи_ - можно задать в виде шаблона

      ```
      Перезвонить по номеру <PhoneNumber>
      ```
  * _Ответственный по задаче_ - задача будет создана только в том случае, если удалось определить ответственного. Варианты: «первый, кто ответил на вызов», «последний, кто ответил на вызов», «ответственный по умолчанию»
* Отвеченный входящий с неизвестного номера
* Отвеченный входящий с известного номера
* Отвеченный исходящий на известный номер
* Отвеченный исходящий на неизвестный номер
* Пропущенный с неизвестного номера
* Пропущенный с известного номера
* Не отвеченный исходящий на известный номер

Для каждого типа звонка можно описать свое правило создания сущностей:

<figure><img src="../../../.gitbook/assets/image (44).png" alt=""><figcaption><p>Раздел описания правила создания сущностей</p></figcaption></figure>

Для каждого DID (номер компании, на который позвонил клиент). Можно создать уникальные правила создания сущностей.
