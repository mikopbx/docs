# Настройка интеграции с Bitrix24

Виды приложения для интеграции с MikoPBX:

* «**бесплатное**» - можно установить без наличия подписки на маркетплейс.
* «**подписка**» - когда у Вас есть подписка на маркетплейс.

Функционал всех вариантов установки идентичен.

## Настройка Bitrix24 <a href="#nastrojka_bitrix24" id="nastrojka_bitrix24"></a>

1. Наше приложение в [**маркетплейс Bitrix 24**](https://www.bitrix24.ru/apps/?app=miko.pbxaskozia).
2. Выполните установку модуля «**MikoPBX**»:

<figure><img src="../../../.gitbook/assets/image (1) (2).png" alt=""><figcaption><p>MikoPBX в маркетплейсе Bitrix24</p></figcaption></figure>

3. Перейдите в раздел «**Телефония**» - «**Настройки телефонии**» - «**Пользователи телефонии**»:

<figure><img src="../../../.gitbook/assets/image (2) (2).png" alt=""><figcaption><p>Раздел "Пользователи телефонии"</p></figcaption></figure>

4. Назначьте сотрудникам внутренние номера:

{% hint style="warning" %}
Назначенные внутренние номера должны существовать в MikoPBX!
{% endhint %}

<figure><img src="../../../.gitbook/assets/image (3) (2).png" alt=""><figcaption><p>Назначение внутренних номеров сотрудникам</p></figcaption></figure>

5. Перейдите в раздел «**Телефония**» - «**Настройки телефонии**» - «**Общие настройки**»:

<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption><p>Раздел "Общие настройки"</p></figcaption></figure>

6. В поле «**Номер для исходящего звонка по умолчанию**» - укажите приложение «**Интеграция с MIKOPBX**» (**следует выполнить после аутентификации модуля со стороны MikoPBX**)

<figure><img src="../../../.gitbook/assets/image (6).png" alt=""><figcaption><p>Настройка номеров по умолчанию</p></figcaption></figure>

## Настройка MIKOPBX <a href="#nastrojka_mikopbx" id="nastrojka_mikopbx"></a>

С АТС MikoPBX обязательно должны быть доступны:

* Ваш портал **Bitrix24** по порту 443
* Сайт **oauth.bitrix.info** по порту **443**

Пример проверки подключения из консоли:

```
openssl s_client -connect  oauth.bitrix.info:443
```

### Настройка модуля <a href="#nastrojka_modulja" id="nastrojka_modulja"></a>

1. Перейдите в меню «**Модули**» → «**Управление модулями**»
2. Установите модуль «**Интеграция с CRM Bitrix24**», перейдите в интерфейс модуля.
3. Заполните поле «**Адрес портала Bitrix24**», **без указания протокола https**, используя пример:&#x20;

```
miko.bitrix24.ru
```

4. Сохраните настройки и включите модуль.
5. Выполните подключение к порталу:

<figure><img src="../../../.gitbook/assets/image (8).png" alt=""><figcaption><p>Подключение к порталу</p></figcaption></figure>

{% hint style="warning" %}
Если на портал была установлена «**Бесплатная**» версия модуля и портал находится в РФ, то модуль будет работать только если выбран регион «**Весь остальной мир**»\
\
**Для сотрудников следует указать телефонные номера.** Именно по ним происходит сопоставление сотрудника из интерфейса MikoPBX с сотрудником из Битрикс 24.
{% endhint %}

### Общие настройки <a href="#obschie_nastrojki" id="obschie_nastrojki"></a>

На вкладке «**Основные настройки**»:

* «**Создавать в CRM сущности, связанные со звонком (Лид / сделка / контакт)**» - если отключить эту опцию, то карточка звонка будет открываться, а Лид / Сделка созданы не будут.
* «**Для каких звонков создавать лид**» - можно ограничить создание лида, к примеру только для входящих.
* «**Использовать перехват на ответственного**» - при поступлении входящего звонка будет выполнен запрос в bitrix, если найден ответственный, то вызов сразу будет направлен на него.
* «**Длительность попытки звонка на ответственного**» - как долго пытаться дозвониться до ответственного сотрудника.\


<figure><img src="../../../.gitbook/assets/image (10).png" alt=""><figcaption><p>Общие настройки</p></figcaption></figure>

На вкладке «**Прочее**» следует настроить:

* «**Очередь для обработки входящего звонка**» - при запросе обратного звонка с сайта вызов сперва поступит на эту очередь. Как только сотрудник ответит, вызов будет направлен клиенту.
* «**Ответственный за пропущенные звонки**» - если на вызов никто не ответил, то для всех созданных сущностей будет назначен указанный ответственный.
* «**Загружать на портал историю звонков**» - если опцию отключить, то будет работать только функция click2call и обратный звонок с сайта.
* «**Загружать файлы записей разговоров на портал в фоновом процессе**» - Раньше загрузка файлов работала одним запросом. В теле запроса отправлялись закодированные данные. Теперь, если включить опцию, сперва от портала получаем ссылку, куда следует загрузить файл. Загрузка файла производится в отдельном процессе. Этот вариант архитектурно более правильный. Из минусов - есть не решенная проблема с прослушиванием такого файла в браузере Safari, в Google Chrome работает исправно.

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption><p>Общие настройки</p></figcaption></figure>

### Ограничения работы по пользователям <a href="#ogranichenija_raboty_po_polzovateljam" id="ogranichenija_raboty_po_polzovateljam"></a>

Модуль позволяет отключить интеграцию и настроить открытие карточки звонка для конкретных сотрудников:

<figure><img src="../../../.gitbook/assets/image (12).png" alt=""><figcaption><p>Раздел "Фильтры по пользователям"</p></figcaption></figure>

Варианты открытия карточки клиента:

* **Не открывать.**
* **Открывать при звонке** - будет открыта сразу, при поступлении звонка от клиента.
* **Открывать при ответе** - карточка будет открыта при ответе на вызов от клиента.

### Внешние линии и сквозная аналитика Bitrix24 <a href="#vneshnie_linii_i_skvoznaja_analitika_b24" id="vneshnie_linii_i_skvoznaja_analitika_b24"></a>

{% hint style="success" %}
Сквозная аналитика Bitrix24 доступна только на тарифах **Команда** и **Компания**. Подробнее можно почитать в [статье](https://helpdesk.bitrix24.ru/open/8726963/). Функционал Внешних линий будет доступен в версии модуля 1.51+.
{% endhint %}

Сквозная аналитика помогает определить, какие рекламные каналы приносят результат и стоят потраченных денег. Для начала на АТС необходимо описать все номера телефонов компании на вкладке «**Внешние линии**».

<figure><img src="../../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

1. В поле «**Номер телефона**» - указываем номер, Как он будет отображаться в Bitrix
2. В поле «**Псевдонимы номера (DID)**» описываем значение, которое присылает провайдер при входящем звонке, псевдонимом может являться логин или номер телефона без кодов города и страны. Подсмотреть его значение можно в истории звонков:

<figure><img src="../../../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>

3. Синхронизация внешних линий с порталом произойдет после перезапуска модуля.
4. В детализации входящего звонка b24 будет видно, на какой номер позвонил клиент:

<figure><img src="../../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

## Обратный звонок с сайта <a href="#obratnyj_zvonok_s_sajta" id="obratnyj_zvonok_s_sajta"></a>

На сайт Bitrix24 возможно добавить форму заказа обратного звонка.

1. В MikoPBX, в настройках модуля на вкладке «**Прочее**» заполните поле «**Очередь для обработки обратного звонка**»:

<figure><img src="../../../.gitbook/assets/image (16).png" alt=""><figcaption><p>"Очередь для обработки обратного звонка" в разделе "Прочее"</p></figcaption></figure>

2. В Bitrix24 перейдите в раздел «**Телефония**» - «**CRM-Форма на сайт**»:

<figure><img src="../../../.gitbook/assets/image (17).png" alt=""><figcaption><p>Раздел «Телефония» - «CRM-Форма на сайт»</p></figcaption></figure>

3. Создайте новую форму.
4. В поле «**Номер телефона**» укажите «**Приложение: Интеграция с бесплатной АТС MikoPBX**».
5. Поле «**Текст, который будет произнесен ответственному перед началом звонка**» можно оставить пустым, оно не используется.

Используйте кнопку «**Открыть сайт**» для теста формы обратного звонка.

<figure><img src="../../../.gitbook/assets/image (18).png" alt=""><figcaption><p>Параметры новой CRM-формы</p></figcaption></figure>

## Возможные решения проблем <a href="#vozmozhnye_reshenija_problem" id="vozmozhnye_reshenija_problem"></a>

Если при попытке подключения модуля внутри MIKOPbx АТС пишет **Отключен от Bitrix24** проверьте:

1. Адрес портала указан без указания протокола и ресурса, например mikopbxb24.ru
2. Проверьте из консоли АТС ping до вашего портала(в примере ping mikopbxb24.ru). [Инструкция](../../../faq/troubleshooting/connecting-to-a-pbx-using-an-ssh-client.md) по доступу к консоли.

### Приложения нет в Marketplace <a href="#prilozhenija_net_v_marketplehjs" id="prilozhenija_net_v_marketplehjs"></a>

{% hint style="warning" %}
В случае, если используется «**коробочная**» версия Bitrix24, то настройка отличается. См. [документацию](https://dev.1c-bitrix.ru/learning/course/index.php?COURSE_ID=99\&LESSON_ID=9289\&LESSON_PATH=8771.8583.8593.9289). В «коробочной» версии нет возможности создать «**Статичное локальное приложение**»
{% endhint %}

На текущий момент не во всех регионах интеграция «**Bitrix 24 и MikoPBX**» доступна в маркетплэйс. В этом случае есть возможность ручной настройки.

Создадим на АТС «**Локальное приложение**»:

1. Перейдите в раздел «**Разработчикам**», на вкладку «**Готовые сценарии**» -> «**Другое**»:\


<figure><img src="../../../.gitbook/assets/image (20).png" alt=""><figcaption><p>Вкладка "Другое"</p></figcaption></figure>

2. Выберите пункт «**Локальное приложение**»:

<figure><img src="../../../.gitbook/assets/image (21).png" alt=""><figcaption><p>Пункт "Локальное приложение"<br></p></figcaption></figure>

3. Скачайте [файл](https://github.com/mikopbx/ModuleBitrix24Integration/blob/aa5eca3b59c5f25d3c8e6a12df00674a03aa0638/BitrixVendorDistr/index.html#L31-L31) и упакуйте его в zip в архив.
4. Заполните настройки локального приложения:

<figure><img src="../../../.gitbook/assets/image (22).png" alt=""><figcaption></figcaption></figure>

5. Выполните действие «**Сохранить**»
6. Теперь приложение будет доступно в разделе «**Маркет**» - «**Разработчикам**» - «**Интеграции**»

<figure><img src="../../../.gitbook/assets/image (23).png" alt=""><figcaption></figcaption></figure>

7. Открыв настройки локального приложения вы сможете скопировать значения «**client\_id**» и «**client\_secret**». Они потребуются при настройке **MikoPBX**

<figure><img src="../../../.gitbook/assets/image (24).png" alt=""><figcaption></figcaption></figure>

В разделе «**Маркет**», станет доступен пункт «**MikoPBX интеграция**», в этом разделе можно получить новый «**Refresh token**»

<figure><img src="../../../.gitbook/assets/image (25).png" alt=""><figcaption></figcaption></figure>

8. В настройка модуля, на стороне АТС, в поле «**Регион**» выберите вариант «**REST API**»
9. Станут доступны два дополнительных поля «**client\_id**» и «**client\_secret**»
10. Заполните поля согласно настройкам «**Локального приложения**» на вашем портале Bitrix**24**

<figure><img src="../../../.gitbook/assets/image (26).png" alt=""><figcaption></figcaption></figure>
